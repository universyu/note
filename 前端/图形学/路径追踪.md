
##  Monte Carlo 积分

假设在积分区间，以 $p(x)$ 为概率密度抽取自变量及其对应的函数值 $f(x)$ ，抽取次数为 `N`，则积分结果为 $\int f(x)\,dx= \displaystyle \frac{1}{N}\sum_{i=1}^N \displaystyle \frac{f(x_{i})}{p(x_{i})}$

## N = 1 路径追踪

 $p$ 点沿 $w_{o}$ 方向发射的光，考虑直接光照以及反射光照（从 $p$ 点观察另一点的直接光照），从 $p$ 考虑四面八方来的反射光，即求积分，但由于取 $N=1$ ，故只考虑一个方向 $w_{i}$ ，从 $p$ 向 $w_{i}$ 发射光线，假设 $p$ 点法向向量 $\vec{n}$ 

### 计算 $p$ 点向 $w_{o}$ 方向发射的光线（shade(p,$w_{o}$)）

引入 $Russian Roulette (RR)$ ， 以 posibility 的概率对结果做 posibility 分之 1 的返回， 以 1 - posibility 的概率对结果做 0 的返回

以 posibility 进行下面的程序，返回值乘以 $\frac{1}{posibility}$
 如果向 $w_{i}$ 打到光源，则求直接光照 $f_{r}(p,w_{i}\to w_{o}) radiance_{i} \vec{n}*\vec{w_{i}} / p(w_{i})$ 
 如果向 $w_{i}$ 打到其它物体，则求其它物体反射光照：递归求解，求下一个点 $q$ 点沿 $-w_{i}$ 方向发射的光
 以 1 - posibility 的概率直接返回 0 
### 划分像素插值结果

由于求 shade 的时候取 N = 1 ， 现在需要划分像素降噪，把像素划分为若干个区域，每个区域都执行以下操作：从相机向该区域发射光线，如果击中场景物体就加其 shade ，否则加 0 ，最后求平均

### 加速

为了减少无效光线数，把光线区分为两部分，直接打到光源或者、打到其它物体。

#### 直接光照部分

渲染方程中的反射项中把积分变量 dw 改成光源的单位面积 dA ，对光源均匀抽样，考虑立体角的定义，以 $p$ 点为球心连向光源，光源法向 $\vec{n^{'}}$ 与连线的夹角 $\theta^{'}$ ，连线长度为 $r$ ，则 $dw = \displaystyle \frac{dA\cos \theta^{'}}{r^{2}}$ 
直接光照：如果 p 和光源的连线没有被其它物体阻挡则为 $f_{r}(p,w_{i}\to w_{o}) radiance_{i} \vec{n}*\vec{w_{i}} \displaystyle \frac{\cos \theta^{'}}{r^{2}}$，否则为 0 

#### 间接光照部分

以 RussianRoulette 的方式进行求间接光照